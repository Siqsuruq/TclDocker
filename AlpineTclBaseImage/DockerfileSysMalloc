# Base Alpine Image with Tcl and Tcllib
# Stage 1: Builder
FROM alpine:latest AS builder

ARG TCL_BUILD_HOME=/opt/tcl_build

# ---- build dependencies ----
RUN apk add --no-cache \
    bash gcc musl-dev openssl openssl-dev build-base zlib-dev \
    bsd-compat-headers unzip wget perl

# ---- download Tcl ----
RUN set -eux; \
    wget https://sourceforge.net/projects/tcl/files/Tcl/9.0.3/tcl903-src.zip -O /tmp/tcl.zip; \
    mkdir -p ${TCL_BUILD_HOME}/tcl; \
    unzip /tmp/tcl.zip -d ${TCL_BUILD_HOME}/tcl

# ---- force SYSTEM malloc in Tcl thread allocator ----
RUN set -eux; \
    cd ${TCL_BUILD_HOME}/tcl/tcl9.0.3; \
    perl -0777 -i -pe ' \
        s/\bvoid\s*\*\s*TclpAlloc\s*\(\s*size_t\s+\w+\s*\)\s*\{.*?\n\}/void *\nTclpAlloc(\n    size_t numBytes)\n{\n    return malloc(numBytes);\n}\n/sg; \
        s/\bvoid\s*TclpFree\s*\(\s*void\s*\*\s*\w+\s*\)\s*\{.*?\n\}/void\nTclpFree(\n    void *ptr)\n{\n    free(ptr);\n    return;\n}\n/sg; \
        s/\bvoid\s*\*\s*TclpRealloc\s*\(\s*void\s*\*\s*\w+\s*,\s*size_t\s+\w+\s*\)\s*\{.*?\n\}/void *\nTclpRealloc(\n    void *oldPtr,\n    size_t numBytes)\n{\n    return realloc(oldPtr, numBytes);\n}\n/sg' \
        generic/tclThreadAlloc.c; \
    \
    grep -n "return malloc(numBytes);" generic/tclThreadAlloc.c; \
    grep -n "free(ptr);" generic/tclThreadAlloc.c; \
    grep -n "return realloc(oldPtr, numBytes);" generic/tclThreadAlloc.c

# ---- build & install Tcl ----
RUN set -eux; \
    cd ${TCL_BUILD_HOME}/tcl/tcl9.0.3/unix; \
    ./configure --enable-64bit; \
    make -j"$(nproc)"; \
    make install; \
    rm -rf ${TCL_BUILD_HOME} /tmp/tcl.zip /var/cache/apk/*

# =====================================================
# Stage 2: Final runtime image
# =====================================================
FROM alpine:latest

ARG BUILD_DATE

LABEL org.opencontainers.image.title="Alpine Tcl (system malloc)"
LABEL org.opencontainers.image.description="Alpine + Tcl 9.0.3 built with system malloc"
LABEL org.opencontainers.image.version="9.0.3-sysmalloc"
LABEL org.opencontainers.image.created=${BUILD_DATE}
LABEL org.opencontainers.image.authors="admin@cloudz.cv"
LABEL org.opencontainers.image.vendor="Cloudz"
LABEL org.opencontainers.image.licenses="MIT"

COPY --from=builder /usr/local /usr/local

RUN apk add --no-cache \
        bash musl openssl zlib libpng rlwrap \
    && echo 'alias tclsh="rlwrap tclsh9.0"' >> /etc/profile \
    && rm -rf /var/cache/apk/*

COPY .tclshrc /root/.tclshrc

CMD ["rlwrap", "tclsh9.0"]
