# Base Alpine Image with Tcl and Tcllib (batteries included) + SYSTEM malloc
# Stage 1: Builder
FROM alpine:latest AS builder

ARG TCL_BUILD_HOME=/opt/tcl_build
ARG TCL_LIB=/usr/local/lib

# Install build dependencies
RUN apk add --no-cache \
    bash gcc musl-dev libpq-dev openssl openssl-dev build-base zlib-dev autoconf tar gzip git \
    libpng-dev curl curl-dev bsd-compat-headers \
    unzip wget perl

# Download, patch (SYSTEM malloc), build and install Tcl first
RUN set -eux; \
    wget https://sourceforge.net/projects/tcl/files/Tcl/9.0.2/tcl902-src.zip -O /tmp/tcl.zip; \
    mkdir -p ${TCL_BUILD_HOME}/tcl; \
    unzip /tmp/tcl.zip -d ${TCL_BUILD_HOME}/tcl; \
    \
    cd ${TCL_BUILD_HOME}/tcl/tcl9.0.2; \
    perl -0777 -i -pe ' \
        s/\bvoid\s*\*\s*TclpAlloc\s*\(\s*size_t\s+\w+\s*\)\s*\{.*?\n\}/void *\nTclpAlloc(\n    size_t numBytes)\n{\n    return malloc(numBytes);\n}\n/sg; \
        s/\bvoid\s*TclpFree\s*\(\s*void\s*\*\s*\w+\s*\)\s*\{.*?\n\}/void\nTclpFree(\n    void *ptr)\n{\n    free(ptr);\n    return;\n}\n/sg; \
        s/\bvoid\s*\*\s*TclpRealloc\s*\(\s*void\s*\*\s*\w+\s*,\s*size_t\s+\w+\s*\)\s*\{.*?\n\}/void *\nTclpRealloc(\n    void *oldPtr,\n    size_t numBytes)\n{\n    return realloc(oldPtr, numBytes);\n}\n/sg' \
        generic/tclThreadAlloc.c; \
    \
    grep -n "return malloc(numBytes);" generic/tclThreadAlloc.c; \
    grep -n "free(ptr);" generic/tclThreadAlloc.c; \
    grep -n "return realloc(oldPtr, numBytes);" generic/tclThreadAlloc.c; \
    \
    cd unix; \
    ./configure --enable-64bit; \
    make -j"$(nproc)"; \
    make install; \
    rm -f /tmp/tcl.zip

# ---- Tcllib ----
RUN set -eux; \
    wget https://github.com/tcltk/tcllib/archive/refs/tags/tcllib-2-0.zip -O /tmp/tcllib-2-0.zip; \
    mkdir -p ${TCL_BUILD_HOME}/tcllib; \
    unzip /tmp/tcllib-2-0.zip -d ${TCL_BUILD_HOME}/tcllib; \
    cd ${TCL_BUILD_HOME}/tcllib/tcllib-tcllib-2-0/; \
    ./configure; \
    make -j"$(nproc)" install; \
    rm -f /tmp/tcllib-2-0.zip

# ---- tDOM ----
RUN set -eux; \
    wget https://tdom.org/downloads/tdom-0.9.6-src.zip -O /tmp/tdom.zip; \
    mkdir -p ${TCL_BUILD_HOME}/tdom; \
    unzip /tmp/tdom.zip -d ${TCL_BUILD_HOME}/tdom; \
    cd ${TCL_BUILD_HOME}/tdom/tdom-0.9.6-src/; \
    ./configure --enable-64bit; \
    make -j"$(nproc)"; \
    make install; \
    rm -f /tmp/tdom.zip

# ---- TclTLS ----
RUN set -eux; \
    wget https://core.tcl-lang.org/tcltls/zip/e19f6b3f18/tcltls-e19f6b3f18.zip -O /tmp/tcltls-2.0b1.zip; \
    mkdir -p ${TCL_BUILD_HOME}/tcltls; \
    unzip /tmp/tcltls-2.0b1.zip -d ${TCL_BUILD_HOME}/tcltls; \
    cd ${TCL_BUILD_HOME}/tcltls/tcltls-e19f6b3f18/; \
    ./configure --enable-64bit; \
    make -j"$(nproc)"; \
    make install-binaries install-libraries; \
    rm -f /tmp/tcltls-2.0b1.zip

# ---- NSF/NX ----
RUN set -eux; \
    wget https://github.com/nm-wu/nsf/archive/refs/heads/main.zip -O /tmp/nsf.zip; \
    mkdir -p ${TCL_BUILD_HOME}/nsf; \
    unzip /tmp/nsf.zip -d ${TCL_BUILD_HOME}/nsf; \
    cd ${TCL_BUILD_HOME}/nsf/nsf-main/; \
    ./configure --enable-64bit --enable-threads; \
    make -j"$(nproc)"; \
    make install; \
    rm -f /tmp/nsf.zip

# ---- TclVFS (plus tclconfig) ----
RUN set -eux; \
    wget --no-check-certificate https://core.tcl-lang.org/tclvfs/zip/166cafa5ca/tclvfs-166cafa5ca.zip -O /tmp/tclvfs.zip; \
    mkdir -p ${TCL_BUILD_HOME}/src/vfs/; \
    unzip /tmp/tclvfs.zip -d ${TCL_BUILD_HOME}/src/vfs; \
    mv ${TCL_BUILD_HOME}/src/vfs/tclvfs-166cafa5ca/* ${TCL_BUILD_HOME}/src/vfs/; \
    \
    wget --no-check-certificate "https://core.tcl-lang.org/tclconfig/zip/b1d23dc5d4/TEA+%28tclconfig%29+Source+Code-b1d23dc5d4.zip" -O /tmp/tclconfig.zip; \
    unzip /tmp/tclconfig.zip -d ${TCL_BUILD_HOME}/src/vfs/tclconfig; \
    mv ${TCL_BUILD_HOME}/src/vfs/tclconfig/TEA*/* ${TCL_BUILD_HOME}/src/vfs/tclconfig/; \
    \
    cd ${TCL_BUILD_HOME}/src/vfs; \
    ./configure; \
    make -j"$(nproc)"; \
    make install; \
    rm -f /tmp/tclvfs.zip /tmp/tclconfig.zip

# ---- OOXML: copy pure Tcl package ----
RUN set -eux; \
    wget --no-check-certificate https://fossil.sowaswie.de/ooxml/uv/ooxml1.10.zip -O /tmp/ooxml1.10.zip; \
    mkdir -p ${TCL_BUILD_HOME}/src/ooxml/; \
    unzip /tmp/ooxml1.10.zip -d ${TCL_BUILD_HOME}/src/ooxml; \
    cp -r ${TCL_BUILD_HOME}/src/ooxml/ooxml1.10 ${TCL_LIB}/; \
    rm -f /tmp/ooxml1.10.zip

# ---- money ----
RUN set -eux; \
    wget https://github.com/Siqsuruq/money-tcl-package/releases/download/v1.0.2/money-1.0.2.zip -O /tmp/money-1.0.2.zip; \
    mkdir -p ${TCL_BUILD_HOME}/money; \
    unzip /tmp/money-1.0.2.zip -d ${TCL_BUILD_HOME}/money; \
    cp -r ${TCL_BUILD_HOME}/money/money ${TCL_LIB}/; \
    rm -f /tmp/money-1.0.2.zip

# ---- mimext + hrfilesize ----
RUN set -eux; \
    git clone https://github.com/Siqsuruq/mimext.git ${TCL_BUILD_HOME}/src/mimext; \
    cp -r ${TCL_BUILD_HOME}/src/mimext ${TCL_LIB}/; \
    git clone https://github.com/Siqsuruq/hrfilesize.git ${TCL_BUILD_HOME}/src/hrfilesize; \
    cp -r ${TCL_BUILD_HOME}/src/hrfilesize ${TCL_LIB}/

# ---- nats-tcl ----
RUN set -eux; \
    wget https://github.com/Kazmirchuk/nats-tcl/archive/refs/tags/v3.1.2.zip -O /tmp/nats-tcl-3.1.2.zip; \
    mkdir -p ${TCL_BUILD_HOME}/nats; \
    unzip /tmp/nats-tcl-3.1.2.zip -d ${TCL_BUILD_HOME}/nats; \
    cp -r ${TCL_BUILD_HOME}/nats/nats-tcl-3.1.2 ${TCL_LIB}/; \
    rm -f /tmp/nats-tcl-3.1.2.zip

# Cleanup build dir
RUN rm -rf ${TCL_BUILD_HOME} /var/cache/apk/*


# Stage 2: Final Image
FROM alpine:latest

ARG BUILD_DATE

LABEL org.opencontainers.image.title="Alpine Tcl batteries-included Image (system malloc)"
LABEL org.opencontainers.image.description="Alpine + Tcl 9.0.2 (system malloc) + Tcllib + tDOM + TLS + NSF + TclVFS + extras."
LABEL org.opencontainers.image.version="1.3-sysmalloc"
LABEL org.opencontainers.image.created=${BUILD_DATE}
LABEL org.opencontainers.image.authors="admin@cloudz.cv"
LABEL org.opencontainers.image.vendor="Cloudz"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.url="https://github.com/Siqsuruq/naviserver/tree/main/AlpineTclBatteriesIncluded"
LABEL org.opencontainers.image.documentation="https://github.com/Siqsuruq/naviserver/tree/main/AlpineTclBatteriesIncluded"
LABEL org.opencontainers.image.source="https://github.com/Siqsuruq/naviserver/tree/main/AlpineTclBatteriesIncluded"

COPY --from=builder /usr/local /usr/local

RUN apk add --no-cache bash musl libpq openssl zlib libpng curl rlwrap \
    && echo 'alias tclsh="rlwrap tclsh9.0"' >> /etc/profile \
    && rm -rf /var/cache/apk/*

COPY .tclshrc /root/.tclshrc

CMD ["rlwrap", "tclsh9.0"]
