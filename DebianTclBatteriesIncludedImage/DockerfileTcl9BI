# ===============================
# Stage 1: Builder
# ===============================
FROM siqsuruq/tcl:tcl9-debian AS builder

ARG TCL_VER=9.0.3
ARG DEBIAN_FRONTEND=noninteractive
ARG TCL_BUILD_HOME=/opt/tcl_build
ARG TCL_LIB=/usr/local/lib

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    zlib1g-dev \
    libssl-dev \
    libxml2-dev \
    git \
    curl unzip ca-certificates \
    && rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    mkdir -p ${TCL_BUILD_HOME}/tclsrc; \
    TCL_ZIP_VER="$(printf '%s' "$TCL_VER" | tr -d '.')"; \
    curl -fsSL "https://sourceforge.net/projects/tcl/files/Tcl/${TCL_VER}/tcl${TCL_ZIP_VER}-src.zip" -o /tmp/tclsrc.zip; \
    unzip /tmp/tclsrc.zip -d ${TCL_BUILD_HOME}/tclsrc; \
    rm -f /tmp/tclsrc.zip

RUN set -eux; \
    mkdir -p ${TCL_BUILD_HOME}/tcl; \
    ln -s ${TCL_BUILD_HOME}/tclsrc/tcl${TCL_VER} ${TCL_BUILD_HOME}/tcl/tcl${TCL_VER}
	
# ---- tDOM ----
RUN set -eux; \
    mkdir -p ${TCL_BUILD_HOME}/tdom; \
    curl -fsSL https://tdom.org/downloads/tdom-0.9.6-src.zip -o /tmp/tdom.zip; \
    unzip /tmp/tdom.zip -d ${TCL_BUILD_HOME}/tdom; \
    cd ${TCL_BUILD_HOME}/tdom/tdom-0.9.6-src; \
    ./configure --prefix=/usr/local --enable-threads --enable-64bit; \
    make -j"$(nproc)"; \
    make install; \
    rm -rf /tmp/tdom.zip ${TCL_BUILD_HOME}/tdom

# ---- TclTLS ----
RUN set -eux; \
    mkdir -p ${TCL_BUILD_HOME}/tcltls; \
    curl -fsSL https://core.tcl-lang.org/tcltls/zip/e19f6b3f18/tcltls-e19f6b3f18.zip -o /tmp/tcltls.zip; \
    unzip /tmp/tcltls.zip -d ${TCL_BUILD_HOME}/tcltls; \
    cd ${TCL_BUILD_HOME}/tcltls/tcltls-e19f6b3f18; \
    ./configure --prefix=/usr/local --enable-threads --enable-64bit; \
    make -j"$(nproc)"; \
    make install-binaries install-libraries; \
    rm -rf /tmp/tcltls.zip ${TCL_BUILD_HOME}/tcltls

# ---- NSF/NX ----
RUN set -eux; \
    git clone https://github.com/nm-wu/nsf.git ${TCL_BUILD_HOME}/nsf; \
    cd ${TCL_BUILD_HOME}/nsf; \
    ./configure --prefix=/usr/local --enable-threads --enable-64bit \
      --with-tcl=/usr/local/lib; \
    make -j"$(nproc)"; \
    make install; \
    rm -rf ${TCL_BUILD_HOME}/nsf

# ---- Pure Tcl packages (pinned releases) ----
ARG HRFILESIZE_VER=2.4.0
ARG MIMEXT_VER=1.2.0

RUN set -eux; \
    mkdir -p "${TCL_LIB}"; \
    \
    # hrfilesize
    curl -fsSL "https://github.com/Siqsuruq/hrfilesize/archive/refs/tags/v${HRFILESIZE_VER}.zip" -o /tmp/hrfilesize.zip; \
    unzip -q /tmp/hrfilesize.zip -d /tmp; \
    rm -rf "${TCL_LIB}/hrfilesize"; \
    mv "/tmp/hrfilesize-${HRFILESIZE_VER}" "${TCL_LIB}/hrfilesize"; \
    rm -f /tmp/hrfilesize.zip; \
    \
    # mimext
    curl -fsSL "https://github.com/Siqsuruq/mimext/archive/refs/tags/v${MIMEXT_VER}.zip" -o /tmp/mimext.zip; \
    unzip -q /tmp/mimext.zip -d /tmp; \
    rm -rf "${TCL_LIB}/mimext"; \
    mv "/tmp/mimext-${MIMEXT_VER}" "${TCL_LIB}/mimext"; \
    rm -f /tmp/mimext.zip; \
    \
    # cleanup
    rm -rf /tmp/hrfilesize-* /tmp/mimext-


# ===============================
# Stage 2: Runtime
# ===============================
FROM siqsuruq/tcl:tcl9-debian

ENV MALLOC_ARENA_MAX=2

RUN apt-get update && apt-get install -y --no-install-recommends \
    libxml2 \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/local /usr/local

RUN ldconfig

CMD ["tclsh9.0"]
