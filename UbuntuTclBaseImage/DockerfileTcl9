# Stage 1: Build Tcl 9
FROM ubuntu:24.04 AS builder
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    libssl-dev \
    zlib1g-dev \
	libpng-dev libzint-dev \
	git

# --- Build Tcl 9.0.3 ---
RUN wget -O tcl9.0.3-src.tar.gz https://sourceforge.net/projects/tcl/files/Tcl/9.0.3/tcl9.0.3-src.tar.gz/download \
    && tar -xf tcl9.0.3-src.tar.gz
WORKDIR /tcl9.0.3/unix
RUN ./configure --prefix=/opt/tcl9 --enable-64bit && make -j$(nproc) && make install

# --- Build TclTLS 2.0 ---
WORKDIR /build/tls
RUN wget -O tcltls-2.0.tar.gz https://core.tcl-lang.org/tcltls/uv/tcltls-2.0-src.tar.gz \
    && tar -xf tcltls-2.0.tar.gz \
	&& rm tcltls-2.0.tar.gz
RUN cd tcltls-* && ./configure --with-tcl=/opt/tcl9/lib --prefix=/opt/tcl9 --with-openssl-dir=/usr \
	--with-openssl-includedir=/usr/include \
    --with-openssl-libdir=/usr/lib/x86_64-linux-gnu \
    && make \
    && make install

# --- Build tDOM 0.9.6 (XML/HTML Parser) ---
WORKDIR /build/tdom
RUN wget -O tdom-0.9.6.tgz http://tdom.org/downloads/tdom-0.9.6-src.tgz \
    && tar -xf tdom-0.9.6.tgz \
    && rm tdom-0.9.6.tgz

# Use a wildcard to enter the directory and then go into 'unix'
RUN cd tdom-*/ && ./configure \
    --with-tcl=/opt/tcl9/lib \
    --prefix=/opt/tcl9 \
    --enable-64bit \
    && make -j$(nproc) \
    && make install

# --- Build NSF (Next Scripting Framework) ---
WORKDIR /build/nsf
RUN git clone https://github.com/nm-wu/nsf.git .
WORKDIR /build/nsf
RUN ./configure --with-tcl=/opt/tcl9/lib --prefix=/opt/tcl9 --enable-64bit \
    && make -j$(nproc) \
    && make install

# --- Build tzint 1.2 ---
WORKDIR /build/tzint
RUN wget -O tzint-1.2.tar.gz https://github.com/aschoepe/tzint/archive/refs/tags/version-1.2.tar.gz \
    && tar -xf tzint-1.2.tar.gz
WORKDIR /build/tzint/tzint-version-1.2
RUN ./configure --with-tcl=/opt/tcl9/lib --prefix=/opt/tcl9 --enable-64bit \
    && make -j$(nproc) \
    && make install

# --- Install Tcllib 2.0 (The Standard Library) ---
WORKDIR /build/tcllib
RUN wget -O tcllib-2.0.tar.gz https://core.tcl-lang.org/tcllib/uv/tcllib-2.0.tar.gz \
    && tar -xf tcllib-2.0.tar.gz
WORKDIR /build/tcllib/tcllib-2.0
# Tcllib uses a 'tclsh' based installer
RUN ./configure --prefix=/opt/tcl9 \
    && /opt/tcl9/bin/tclsh9.0 installer.tcl \
       -pkg-path /opt/tcl9/lib \
       -no-gui -no-wait -no-html

# Stage 2: Chisel the Ubuntu 24.04 base
FROM ubuntu:24.04 AS chiseller
RUN apt-get update && apt-get install -y ca-certificates curl

# Use the v1.4.0 direct download link
RUN curl -sSL https://github.com/canonical/chisel/releases/download/v1.4.0/chisel_v1.4.0_linux_amd64.tar.gz -o /tmp/chisel.tar.gz \
    && tar -xvf /tmp/chisel.tar.gz -C /usr/local/bin/ \
    && rm /tmp/chisel.tar.gz

WORKDIR /rootfs
RUN chisel cut --release ubuntu-24.04 --root /rootfs \
    base-files_base \
    base-files_release-info \
    ca-certificates_data \
    libc6_libs \
    libssl3t64_libs \
    zlib1g_libs

# Stage 3: Final Image
FROM scratch
COPY --from=chiseller /rootfs /
COPY --from=builder /opt/tcl9 /opt/tcl9

# Manually copy the zint and png libraries that Chisel still doesnt exists
COPY --from=builder /usr/lib/x86_64-linux-gnu/libzint.so* /usr/lib/x86_64-linux-gnu/
COPY --from=builder /usr/lib/x86_64-linux-gnu/libpng16.so* /usr/lib/x86_64-linux-gnu/

# External mount point for user packages
WORKDIR /external_libs

ENV PATH="/opt/tcl9/bin:${PATH}"
ENV TCL_LIBRARY="/opt/tcl9/lib/tcl9.0"
ENV TCLLIBPATH="/external_libs /opt/tcl9/lib"
ENV SSL_CERT_FILE="/etc/ssl/certs/ca-certificates.crt"
ENTRYPOINT ["tclsh9.0"]