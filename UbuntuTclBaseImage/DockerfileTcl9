# Stage 1: Build Tcl 9
FROM ubuntu:24.04 AS builder
RUN apt-get update && apt-get install -y build-essential wget

# Updated link for version 9.0.3
RUN wget https://prdownloads.sourceforge.net \
    && tar -xf tcl9.0.3-src.tar.gz

WORKDIR /tcl9.0.3/unix
RUN ./configure --prefix=/opt/tcl9 && make -j$(nproc) && make install

# Stage 2: Chisel the Ubuntu base
FROM ubuntu:24.04 AS chiseller
RUN apt-get update && apt-get install -y ca-certificates curl

# Use the ACTUAL direct download link for the Chisel binary
RUN curl -sSL https://github.com -o /tmp/chisel.tar.gz \
    && tar -xvf /tmp/chisel.tar.gz -C /usr/local/bin/ \
    && rm /tmp/chisel.tar.gz

WORKDIR /rootfs
# Cut the slices for Ubuntu 24.04
RUN chisel cut --release ubuntu-24.04 --root /rootfs \
    base-files_base \
    base-files_release-info \
    ca-certificates_data \
    libc6_libs \
    libssl3_libs \
    zlib1g_libs

# Stage 3: Final Image
FROM scratch
COPY --from=chiseller /rootfs /
# Ensure the entire /opt/tcl9 folder is copied, not just the bin
COPY --from=builder /opt/tcl9 /opt/tcl9

ENV PATH="/opt/tcl9/bin:${PATH}"
ENV TCL_LIBRARY="/opt/tcl9/lib/tcl9.0"
ENTRYPOINT ["tclsh9.0"]