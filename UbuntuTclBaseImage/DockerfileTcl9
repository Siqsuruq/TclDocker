# Stage 1: Build Tcl 9
FROM ubuntu:24.04 AS builder
RUN apt-get update && apt-get install -y build-essential wget

# Updated link for version 9.0.3
RUN wget https://prdownloads.sourceforge.net \
    && tar -xf tcl9.0.3-src.tar.gz

WORKDIR /tcl9.0.3/unix
RUN ./configure --prefix=/opt/tcl9 && make -j$(nproc) && make install

# Stage 2: Chisel the Ubuntu base
FROM ubuntu:24.04 AS chiseller
RUN apt-get update && apt-get install -y ca-certificates
ADD https://github.com /tmp/chisel.tar.gz
RUN tar -xvf /tmp/chisel.tar.gz -C /usr/local/bin/

WORKDIR /rootfs
# Added zlib and ca-certificates for Tcl 9 features
RUN chisel cut --root /rootfs \
    base-files_base \
    base-files_release-info \
    ca-certificates_data \
    libc6_libs \
    libssl3_libs \
    zlib1g_libs

# Stage 3: Final Chiseled Image
FROM scratch
COPY --from=chiseller /rootfs /
COPY --from=builder /opt/tcl9 /opt/tcl9
ENV PATH="/opt/tcl9/bin:${PATH}"
ENTRYPOINT ["tclsh9.0"]