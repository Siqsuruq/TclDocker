# Stage 1: Build Tcl 9
FROM ubuntu:24.04 AS builder
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    libssl-dev \
    zlib1g-dev

# Updated link for version 9.0.3
RUN wget -O tcl9.0.3-src.tar.gz https://sourceforge.net/projects/tcl/files/Tcl/9.0.3/tcl9.0.3-src.tar.gz/download \
    && tar -xf tcl9.0.3-src.tar.gz

WORKDIR /tcl9.0.3/unix
RUN ./configure --prefix=/opt/tcl9 --enable-64bit && make -j$(nproc) && make install

# --- Build TclTLS 2.0 ---
WORKDIR /build/tls
RUN wget -O tcltls-2.0.tar.gz https://core.tcl-lang.org/tcltls/uv/tcltls-2.0-src.tar.gz \
    && tar -xf tcltls-2.0.tar.gz \
	&& rm tcltls-2.0.tar.gz

# Use a wildcard to enter whatever folder was extracted
RUN cd tcltls-* && ./configure --with-tcl=/opt/tcl9/lib --prefix=/opt/tcl9 --with-openssl-dir=/usr \
	--with-openssl-includedir=/usr/include \
    --with-openssl-libdir=/usr/lib/x86_64-linux-gnu \
    && make \
    && make install

# Stage 2: Chisel the Ubuntu 24.04 base
FROM ubuntu:24.04 AS chiseller
RUN apt-get update && apt-get install -y ca-certificates curl

# Use the v1.4.0 direct download link
RUN curl -sSL https://github.com/canonical/chisel/releases/download/v1.4.0/chisel_v1.4.0_linux_amd64.tar.gz -o /tmp/chisel.tar.gz \
    && tar -xvf /tmp/chisel.tar.gz -C /usr/local/bin/ \
    && rm /tmp/chisel.tar.gz

WORKDIR /rootfs
RUN chisel cut --release ubuntu-24.04 --root /rootfs \
    base-files_base \
    base-files_release-info \
    ca-certificates_data \
    libc6_libs \
    libssl3t64_libs \
    zlib1g_libs

# Stage 3: Final Image
FROM scratch
COPY --from=chiseller /rootfs /
COPY --from=builder /opt/tcl9 /opt/tcl9

ENV PATH="/opt/tcl9/bin:${PATH}"
ENV TCL_LIBRARY="/opt/tcl9/lib/tcl9.0"
ENV TCLLIBPATH="/opt/tcl9/lib"
ENTRYPOINT ["tclsh9.0"]